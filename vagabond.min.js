!function(a){"use strict";var b=function(){var a=function(){var a,c,d,e=arguments,f=null;for(a=0;a<e.length;a+=1)for(d=e[a].split("."),f=b,c="VAGABOND"===d[0]?1:0;c<d.length;c++)f[d[c]]=f[d[c]]||{},f=f[d[c]];return f},c=function(a){var b=document.body.getElementsByClassName("logs")[0],c=document.createElement("span");c.innerText=a+"\n",b.insertBefore(c,b.firstChild)},d=function(a,b,c){return"["+a+"] "+b+" ["+c+"]"};return this.namespace=a,this.writeToLog=c,this.toSentence=d,this}.call(b||{});a.VAGABOND=b}(this),function(){"use strict";VAGABOND.namespace("VAGABOND.DATA_STRUCTURES.MATRIX"),VAGABOND.DATA_STRUCTURES.MATRIX=function(a){var b={};return b.init=function(a,b,c){return this.grid=[],this.height=a,this.width=b,this.setDefaults(c),this},b.setDefaults=function(a){this.defaults=UTIL.extend(a,{initValue:function(){return 0},formatValue:function(a){return a},formatReturn:function(a){return a},formatting:{OPEN:"[",SEPERATOR:", ",CLOSE:"]\n"}})},b.initGrid=function(a){var b,c;for(void 0===a&&(a=this.defaults.initValue),b=0;b<this.width;b++)for(this.grid[b]=[],c=0;c<this.height;c++)this.set(b,c,a(b,c,this.height,this.width));return this},b.get=function(a,b){return this.grid[a][b]},b.set=function(a,b,c){if(!this.isValidCoordinate(a,b))throw"OutOfBoundError: the coordinate ("+a+", "+b+") is out of bounds";this.grid[a][b]=c},b.wrappedGet=function(a,b){var c=this.wrapCoor(a,b);return this.get(c.x,c.y)},b.wrappedSet=function(a,b,c){var d=this.wrapCoor(a,b);return this.set(d.x,d.y,c)},b.clampedGet=function(a,b){var c=this.clampCoor(a,b);return this.get(c.x,c.y)},b.clampedSet=function(a,b,c){var d=this.clampCoor(a,b);return this.set(d.x,d.y,c)},b.clampCoor=function(a,b){return{x:UTIL.clamp(a,0,this.width-1),y:UTIL.clamp(b,0,this.height-1)}},b.wrapCoor=function(a,b){return{x:UTIL.wrap(a,0,this.width),y:UTIL.wrap(b,0,this.height)}},b.isValidCoordinate=function(a,b){return a>=0&&a<this.width&&b>=0&&b<this.height},b.clone=function(){var a=Object.create(b);return a.init(this.height,this.width,this.defaults),a.grid=JSON.parse(JSON.stringify(this.grid)),a},b.toString=function(a){var b,c,d,e="";for(a=UTIL.extend(a,{formatValue:this.defaults.formatValue,formatReturn:this.defaults.formatReturn,formatting:this.defaults.formatting}),b=0;b<this.width;b++){for(e+=a.formatting.OPEN,d="",c=0;c<this.height;c++)e+=d+a.formatValue.call(this,this.get(b,c),b,c),d=a.formatting.SEPERATOR;e+=a.formatting.CLOSE}return a.formatReturn.call(this,e)},a.Matrix=b,a}(VAGABOND.DATA_STRUCTURES.MATRIX)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.DATA_STRUCTURES.GRAPH"),VAGABOND.DATA_STRUCTURES.GRAPH=function(a){var b=VAGABOND.DATA_STRUCTURES.MATRIX.Matrix,c={};c.init=function(a,b,c,d){return this.id=a,this.x=b,this.y=c,this.weight=d,this.neighbors=[],this.entities=[],this};var d={};return d.init=function(a){this.height=a.height,this.width=a.width,this.vertexMatrix=Object.create(b).init(this.height,this.width),this.vertexMatrix.initGrid(),this.vertices=[],this.vertexCount=0;var d,e,f,g,h;for(d=0;d<this.width;d++)for(e=0;e<this.height;e++)f=a.get(d,e),h=this.vertexCount,g=Object.create(c).init(h,d,e,f),this.vertexMatrix.set(d,e,g),this.vertices[h]=g,this.vertexCount++;var i,j,k;for(d=0;d<this.width;d++)for(e=0;e<this.height;e++)for(g=this.vertexMatrix.get(d,e),i=0;i<UTIL.ADJACENT.length;i++)j=UTIL.ADJACENT[i],this.vertexMatrix.isValidCoordinate(d+j[0],e+j[1])&&(k=this.vertexMatrix.get(d+j[0],e+j[1]),g.neighbors.push(k));return this},d.adjacent=function(a,b){return-1!==a.neighbors.indexOf(b)},d.getEdgeValue=function(a,b){return Math.max(a.weight,b.weight)},d.getVertex=function(a,b){return this.vertexMatrix.get(a,b)},d.setVertex=function(a,b,c){return this.vertexMatrix.set(a,b,c)},a.Graph=d,a.Vertex=c,a}(VAGABOND.DATA_STRUCTURES.GRAPH)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ALGORITHMS"),VAGABOND.ALGORITHMS=function(a){var b=function(a,b){function c(b,c){function e(a,b,c,d,e){var f=h(a,b,c);e.wrappedSet(a,b,g(f,d,e))}function f(a,b,c,d,e){var f=i(a,b,c);e.wrappedSet(a,b,g(f,d,e))}function g(a,b,c){var d,e,f=0,g=0;for(d=0;d<a.length;d++)e=a[d],c.isValidCoordinate(e.x,e.y)&&(f+=c.wrappedGet(e.x,e.y),g++);return f/=g,f+=Math.random()*b-b/2}function h(a,b,c){var d=Math.floor(c/2);return[{x:a+d,y:b+d},{x:a+d,y:b-d},{x:a-d,y:b+d},{x:a-d,y:b-d}]}function i(a,b,c){var d=Math.floor(c/2);return[{x:a+d,y:b},{x:a-d,y:b},{x:a,y:b+d},{x:a,y:b-d}]}var j,k,l=Math.floor(b/2);for(j=l;d+l>=j;j+=b)for(k=l;d+l>=k;k+=b)a.isValidCoordinate(k,j)&&e(k,j,b,c,a);for(j=0;d>=j;j+=b)for(k=0;d>=k;k+=b)a.isValidCoordinate(k+l,j)&&f(k+l,j,b,c,a),a.isValidCoordinate(k,j+l)&&f(k,j+l,b,c,a)}for(var d=a.width-1,e=d;e>1;)c(e,b),e/=2,b/=2},c=function(a,b){function c(){function b(a,b,c){var d,e,f,g,h,i,j=-(1/0),k={};for(d=0;d<UTIL.ADJACENT.length;d++)e=UTIL.ADJACENT[d],f=b+e[0],g=c+e[1],a.isValidCoordinate(f,g)&&(h=Math.floor(a.get(f,g)),k[h]=k[h]?k[h]+1:1,j<k[h]&&(j=k[h],i=h));return i}var c=a.clone(),d=b.bind(null,c);a.initGrid(d)}var d;for(d=0;b>d;d++)c()},d=function(a,b,c){function d(a){return a.pathWeight=1/0,a.heuristic=10*UTIL.manhattanDistance(a,c),a.getTotal=function(){return this.pathWeight+this.heuristic},a.previousVertex=void 0,a}function e(a){for(var b=[];void 0!==a.previousVertex;){var c=a.previousVertex;b.unshift({dx:a.x-c.x,dy:a.y-c.y}),a=c}return b}var f,g,h,i=[],j=[],k=!1;for(var l in a.vertices)f=d(a.vertices[l]),f.x===b.x&&f.y===b.y&&(f.pathWeight=0),j.push(f);for(;!k&&0!==j.length;)for(j.sort(function(a,b){return-1*(a.getTotal()-b.getTotal())}),f=j.pop(),i.push(f),g=0;g<f.neighbors.length;g++)h=f.neighbors[g],-1===i.indexOf(h)&&(h.pathWeight=f.pathWeight+a.getEdgeValue(f,h),h.previousVertex=f,i.push(h),j.push(h),h.x===c.x&&h.y===c.y&&(k=!0));return e(a.getVertex(c.x,c.y))};return a.diamondSquare=b,a.cellularAutomata=c,a.aStar=d,a}(VAGABOND.ALGORITHMS)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.MAPS"),VAGABOND.MAPS=function(a){var b=VAGABOND.DATA_STRUCTURES.MATRIX.Matrix,c=VAGABOND.DATA_STRUCTURES.GRAPH.Graph,d=Object.create(b);return d.init=function(a,d,e){return b.init.call(this,a,d,e),this.graph=Object.create(c),this},d.initGrid=function(a){b.initGrid.call(this,a),this.graph.init(this)},d.renderTo=function(a,b){var c,d,e;for(void 0===b&&(b=this.defaults.formatValue),e=a.getOrigin(),c=e.y;c<a.height+e.y;c++)for(d=e.x;d<a.width+e.x;d++)this.isValidCoordinate(d,c)&&a.set(d-e.x,c-e.y,b.call(this,this.get(d,c),d,c))},d.generate=function(){},a.Map=d,a}(VAGABOND.MAPS)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.MAPS.FACTORY"),VAGABOND.MAPS.FACTORY=function(a){var b=VAGABOND.MAPS.Map,c=VAGABOND.ALGORITHMS,d=function(a,d){d=UTIL.extend(d,{formatValue:function(a){return Math.floor(UTIL.clamp(a,0,31)).toString(32)},initValue:function(){return UTIL.random(6,26)}});var e=Object.create(b).init(a,a,d);return e.generate=function(){this.initGrid(),c.diamondSquare(this,30)},e.type="height",e},e=32767,f=function(a,d,f){f=UTIL.extend(f,{formatValue:function(a){return a===e?"O":1===a?".":" "},initValue:function(){return Math.random()<.45?e:1}});var g=Object.create(b).init(a,d,f);return g.generate=function(){this.initGrid(),c.cellularAutomata(this,8)},g.type="dungeon",g};return a.createHeightMap=d,a.createDungeonMap=f,a.WALL_WEIGHT=e,a}(VAGABOND.MAPS.FACTORY)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ENTITIES"),VAGABOND.ENTITIES=function(a){var b={};return b.init=function(a,b,c,d){return this.id=a,this.x=b,this.y=c,this["char"]=d,this.actionCounts={main:0,secondary:0,minor:0},this},b.takeTurn=function(){},b.getTraits=function(){return{x:this.x,y:this.y,id:this.id}},b.toString=function(a,b){return JSON.stringify(this.getTraits(),a,b)},b.renderTo=function(a,b){b=void 0!==b?b:function(a){return a["char"]};var c=a.getOrigin(),d=this.x-c.x,e=this.y-c.y;a.isValidCoordinate(d,e)&&a.set(d,e,b.call(this,this))},a.Entity=b,a}(VAGABOND.ENTITIES)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ENTITIES"),VAGABOND.ENTITIES=function(a){var b=VAGABOND.ENTITIES.Entity,c=Object.create(b);return c.init=function(a,c,d,e,f){return b.init.call(this,a,c,d,e),this.hp=f,this},b.takeTurn=function(){this.hp<0&&(this["char"]="X",this.move=function(){})},a.KillableEntity=c,a}(VAGABOND.ENTITIES)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ENTITIES"),VAGABOND.ENTITIES=function(a){var b=VAGABOND.ENTITIES.KillableEntity,c=VAGABOND.MAPS.FACTORY.WALL_WEIGHT,d=Object.create(b);return d.init=function(a,c,d,e,f){return b.init.call(this,a,c,d,e,f),this.movement=6,this},d.move=function(a,b){this.hp++,this.x+=a,this.y+=b},d.isValidMove=function(a,b,d){var e,f=d.map,g=this.x+a,h=this.y+b,i=!1;for(e=0;e<d.entityPool.length;e++){var j=d.entityPool[e];j.x===g&&j.y===h&&j.hp>0&&(i=!0)}return f.isValidCoordinate(g,h)&&f.get(g,h)!==c&&!i},a.MovableKillableEntity=d,a}(VAGABOND.ENTITIES)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ENTITIES"),VAGABOND.ENTITIES=function(a){var b=VAGABOND.ENTITIES.MovableKillableEntity,c=Object.create(b);return c.init=function(a,c,d,e,f,g,h){return b.init.call(this,UTIL.generateUUID(),a,c,d,e),this.name=f,this.type=g,this.strength=h,this},c.getFullName=function(){return this.name+", the "+this.type},c.attack=function(a){VAGABOND.writeToLog(VAGABOND.toSentence(this.getFullName(),"attacked",a.getFullName())),a.hp-=this.strength,a.hp<0&&(VAGABOND.writeToLog(VAGABOND.toSentence(this.getFullName(),"killed",a.getFullName())),a.move=function(){},a.attack=function(){},a.takeTurn=function(){},a["char"]="X")},a.Monster=c,a}(VAGABOND.ENTITIES)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ENTITIES.ENEMIES"),VAGABOND.ENTITIES.ENEMIES=function(a){function b(){var a=UTIL.ADJACENT,b=a[Math.floor(UTIL.random(a.length))];return{dx:b[0],dy:b[1]}}var c=VAGABOND.ENTITIES.Monster,d=VAGABOND.ALGORITHMS,e=Object.create(c);return e.init=function(a,b,d,e){return c.init.call(this,a,b,"%",d,e,"Goblin",3)},e.takeTurn=function(a){c.takeTurn.call(this);var d={x:a.player.x,y:a.player.y},e={x:this.x,y:this.y},f=UTIL.manhattanDistance(e,d);if(1===f&&a.player.hp>0)this.attack(a.player,a);else if(10>f&&a.player.hp>0)this.takeNextMove(a);else{var g=b();this.isValidMove(g.dx,g.dy,a)&&this.move(g.dx,g.dy)}},e.takeNextMove=function(a){var b={x:a.player.x,y:a.player.y},c={x:this.x,y:this.y},e=d.aStar(a.map.graph,c,b),f=e.shift();this.isValidMove(f.dx,f.dy,a)&&this.move(f.dx,f.dy)},a.Goblin=e,a}(VAGABOND.ENTITIES.ENEMIES)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.ENTITIES"),VAGABOND.ENTITIES=function(a){var b=VAGABOND.ENTITIES.Monster,c=Object.create(b);return a.PlayerEntity=c,a}(VAGABOND.ENTITIES)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.CONTROLS"),VAGABOND.CONTROLS=function(a){var b=UTIL.VIRTUAL_KEYS.VirtualKeys,c={};return c.init=function(){return this.eventStack=[],this.codes={},this.codes[b.VK_LEFT]="screenLeft",this.codes[b.VK_RIGHT]="screenRight",this.codes[b.VK_UP]="screenUp",this.codes[b.VK_DOWN]="screenDown",this.codes[b.VK_A]="charLeft",this.codes[b.VK_D]="charRight",this.codes[b.VK_W]="charUp",this.codes[b.VK_S]="charDown",this.codes[b.VK_SPACE]="generate",this.codes[b.VK_1]="diamondSquare",this.codes[b.VK_2]="cellularAutomata",this.codes[b.VK_RETURN]="initMap",this.codes[b.VK_CONTROL]="switchMapType",document.addEventListener("keydown",this.onKey.bind(this),!1),this},c.onKey=function(a){var b=this.codes[a.keyCode];void 0!==b&&(0===this.eventStack.length&&this.eventStack.push({state:b,render:!0}),void 0!==a.preventDefault&&a.preventDefault(),void 0!==a.stopPropagation&&a.stopPropagation())},a.Listener=c,a}(VAGABOND.CONTROLS)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.CONTROLS"),VAGABOND.CONTROLS=function(a){function b(a,b){var e=b.map;"generate"===a?e.generate():"diamondSquare"===a?c.diamondSquare(e,30):"cellularAutomata"===a?c.cellularAutomata(e,1):"initMap"===a?e.initGrid():"switchMapType"===a&&("height"===e.type?b.map=d.createDungeonMap(129,129):b.map=d.createHeightMap(129),b.map.initGrid())}var c=VAGABOND.ALGORITHMS,d=VAGABOND.MAPS.FACTORY,e={};return e.init=function(a){return this.listener=a,this},e.processInput=function(a,c,d){if(this.listener.eventStack.length>0){var e=this.listener.eventStack.pop(),f=e.state,g={screenUp:{dx:0,dy:-1,entity:a,useTurn:!1},screenDown:{dx:0,dy:1,entity:a,useTurn:!1},screenLeft:{dx:-1,dy:0,entity:a,useTurn:!1},screenRight:{dx:1,dy:0,entity:a,useTurn:!1},charUp:{dx:0,dy:-1,entity:c,useTurn:!0},charDown:{dx:0,dy:1,entity:c,useTurn:!0},charLeft:{dx:-1,dy:0,entity:c,useTurn:!0},charRight:{dx:1,dy:0,entity:c,useTurn:!0}},h=g[f];if(h&&h.entity.isValidMove(h.dx,h.dy,d)&&h.entity.move(h.dx,h.dy),"click"===f){var i={x:e.coordinate.x,y:e.coordinate.y},j=d.getEntitiesAt(i)[0];void 0!==j&&1===UTIL.manhattanDistance(c,j)&&j.hp>0&&(c.attack(j),e.useTurn=!0)}(h&&h.useTurn||e.useTurn)&&d.takeTurn(),b(f,d),e.render&&(d.renderTo(a),a.renderToElement(document.body.getElementsByClassName("map")[0]),Object.create(VAGABOND.CONTROLS.MapListener).init(this.listener))}},a.Controller=e,a}(VAGABOND.CONTROLS)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.CONTROLS"),VAGABOND.CONTROLS=function(a){var b={};return b.init=function(a){function b(b){var c={x:parseInt(b.dataset.x),y:parseInt(b.dataset.y)};a.eventStack.push({state:"click",render:!0,useTurn:!1,coordinate:c})}for(var c=document.getElementsByClassName("tile"),d=0;d<c.length;d++){var e=c[d];e.addEventListener("click",b.bind(this,e),!1)}return this},a.MapListener=b,a}(VAGABOND.CONTROLS)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.SCREEN"),VAGABOND.SCREEN=function(a){var b=VAGABOND.DATA_STRUCTURES.MATRIX.Matrix,c=Object.create(b);return c.init=function(a,c,d,e){return this.originX=d,this.originY=e,b.init.call(this,a,c,{initValue:function(){return" "}}).initGrid(),this},c.clear=b.initGrid,c.move=function(a,b){this.originX+=a,this.originY+=b},c.isValidMove=function(a,b,c){var d=c.map,e=this.originX+a,f=this.originY+b;return d.isValidCoordinate(e+this.width-1,f+this.height-1)&&d.isValidCoordinate(e+this.width-1,f)&&d.isValidCoordinate(e,f+this.height-1)&&d.isValidCoordinate(e,f)},c.getOrigin=function(){return{x:this.originX,y:this.originY}},c.toElement=function(a){var b,c,d,e,f;for(a=UTIL.extend(a,{formatValue:function(a){return a},formatElement:function(a,b,c){var d=this.getOrigin(),e=document.createElement("span");return e.className="tile tile-"+a,e.dataset.x=b+d.x,e.dataset.y=c+d.y,e.innerHTML=a,e}}),d=document.createElement("div"),d.className="screen",b=0;b<this.height;b++){for(c=0;c<this.width;c++)f=a.formatValue.call(this,this.get(c,b),c,b),e=a.formatElement.call(this,f,c,b),d.appendChild(e);d.appendChild(document.createElement("br"))}return d},c.renderToElement=function(a){var b=this.toElement();a.innerHTML=b.innerHTML},a.Screen=c,a}(VAGABOND.SCREEN)}(),function(){"use strict";VAGABOND.namespace("VAGABOND.LEVEL"),VAGABOND.LEVEL=function(a){var b={};return b.init=function(a,b){return this.entityPool=void 0===b?{}:b,this.map=a,this},b.getEntitiesAt=function(a){for(var b=[],c=0;c<this.entityPool.length;c++){var d=this.entityPool[c];d.x===a.x&&d.y===a.y&&b.push(d)}return b},b.addEntity=function(){var a=arguments;a[0]instanceof Array&&(a=a[0]);for(var b in a){var c=a[b];this.entityPool[c.id]=c}Array.prototype.push.apply(this.entityPool,a)},b.setPlayer=function(a){this.player=a},b.takeTurn=function(){var a,b;for(a=0;a<this.entityPool.length;a++)b=this.entityPool[a],b.takeTurn(this)},b.renderTo=function(a){var b;for(a.clear(),this.map.renderTo(a),b=0;b<this.entityPool.length;b++)this.entityPool[b].renderTo(a)},a.Level=b,a}(VAGABOND.LEVEL)}(),function(a){"use strict";var b=VAGABOND.ENTITIES.PlayerEntity,c=VAGABOND.ENTITIES.ENEMIES.Goblin,d=VAGABOND.MAPS.FACTORY,e=VAGABOND.SCREEN.Screen,f=VAGABOND.LEVEL.Level,g=VAGABOND.CONTROLS.Listener,h=VAGABOND.CONTROLS.Controller,i=Object.create(b).init(4,4,"#",34,"Milo","Beermaster",15),j=Object.create(c).init(5,10,50,"Grot"),k=Object.create(c).init(8,15,60,"Snik"),l=d.createDungeonMap(40,90);l.generate();var m=Object.create(e).init(20,80,0,0),n=Object.create(g).init(),o=Object.create(h).init(n),p=Object.create(f).init(l);a.level=p,n.eventStack.unshift({state:"do nothing",render:!0}),p.addEntity(i,j,k);var q;for(q=0;10>q;q++){var r=Object.create(c).init(Math.floor(Math.random()*l.width),Math.floor(Math.random()*l.height),50,"#"+q);r.getFullName=function(){return"Random "+this.type+" "+this.name},p.addEntity(r)}p.setPlayer(i);var s=function(){o.processInput(m,i,p),UTIL.setTimeout(s,30)};s()}(this);
//# sourceMappingURL=vagabond.min.js.map